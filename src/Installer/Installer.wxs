<?xml version="1.0" encoding="UTF-8"?>
<!-- These variables define the Windows Installer product version, product code and upgrade code. They   -->
<!-- will be used later on in this file.  this value should be B U I  LD_SCRIPT_MUST_REPLACE_AT_RUNTIME  (in quotes)-->
<?define Property_ProductVersion = ".*" ?>
<!-- Generate a new one for each installer, since it only uses the major upgrade approach for msi installers.
cf: http://wix.sourceforge.net/manual-wix3/major_upgrade.htm
and http://www.joyofsetup.com/2010/01/16/major-upgrades-now-easier-than-ever/
for details on why going the major upgrade route is the right answer for an msi-only install system is right.
-->
<?define Property_ProductCode = "*" ?>
<!--Don't even think of EVER changing the Property_UpgradeCode. -->
<?define Property_UpgradeCode = "C1EDBBD1-E382-11DE-8A39-0800200C9A66" ?>

<!-- good intro to the component vs. file thing, and why each file here is a separate component:
http://blogs.msdn.com/robmen/archive/2003/10/04/56479.aspx -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <Product Id="$(var.Property_ProductCode)" Name="FLEx Bridge" Language="1033" Version="$(var.Property_ProductVersion)" Manufacturer="SIL International" UpgradeCode="$(var.Property_UpgradeCode)">

	<!-- autogenerated package id -->
	<Package Id="*" Compressed="yes" InstallerVersion="200"/>

	<UIRef Id="WixUI_Minimal"/>
	<WixVariable Id="WixUILicenseRtf" Value="license.rtf"/>
	<WixVariable Id="WixUIBannerBmp" Value="BannerWithSILLogo.bmp" />
	<WixVariable Id="WixUIDialogBmp" Value="DialogBGWithSILLogo.bmp" />

	<!-- Using afterInstallFinalize will allow the apparent downgrading of files in the Chorus merge module. -->
	<MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="A newer version of FLEx Bridge is already installed. Setup will now exit." Schedule="afterInstallValidate"/>

	<Property Id="MANUFACTURERREGKEY">SIL</Property>
	<!-- The following will set properties A[FW9INSTALLDIR] and B[FW9DEVINSTALLDIR] to the result of two different registry searches.
	If the search for B[FW9DEVINSTALLDIR] was successful, it overrides the value of A[FW9INSTALLDIR] with the value of B[FW9DEVINSTALLDIR].
	See: http://stackoverflow.com/questions/1690162/wix-set-a-property-based-on-a-condition -->
	<Property Id="FW9INSTALLDIR">
	  <!-- Real users and devs have this registry entry. But, a dev machine has it set to DistFiles. -->
	  <RegistrySearch Id="SearchForFW9" Root="HKLM" Key="SOFTWARE\[MANUFACTURERREGKEY]\FieldWorks\9" Name="RootCodeDir" Type="raw"/>
	</Property>
	<Property Id="FIELDWORKSMINIMUMINSTALLEDVERSION">
	  <DirectorySearch Id="FWVersion" Path="[FW9INSTALLDIR]">
		<!-- 8.0.3.41467 was the actual number the day the FW Beta 4 was released, but I understand one then needs to go one notch under that to findit. -->
		<FileSearch Name="FieldWorks.exe" MinVersion="8.0.3.41466"/>
	  </DirectorySearch>
	</Property>
	<Property Id="DEVFW9BUILDDIR">
	  <!-- Devs (only) have this registry entry. -->
	  <RegistrySearch Id="SearchForFW9DevDir" Root="HKLM" Key="SOFTWARE\[MANUFACTURERREGKEY]\FieldWorks\9" Name="FwExeDir" Type="raw"/>
	</Property>
	<Property Id="DEVFIELDWORKSMINIMUMINSTALLEDVERSION">
	  <DirectorySearch Id="DevFWVersion" Path="[DEVFW9BUILDDIR]">
					<!-- 8.0.3.41467 was the actual number the day the FW Beta 4 was released, but I understand one then needs to go one notch under that to findit. -->
		<FileSearch Name="FieldWorks.exe" MinVersion="8.0.3.41466"/>
	  </DirectorySearch>
	</Property>

	<!-- Use the dev entry, but only if set.
	<SetProperty Id="FW9INSTALLDIR" Before="SetFIELDWORKSMINIMUMINSTALLEDVERSION" Value="[DEVFW9BUILDDIR]">DEVFW9BUILDDIR</SetProperty> -->
	<SetProperty Id="FIELDWORKSMINIMUMINSTALLEDVERSION" Before="LaunchConditions" Value="[DEVFIELDWORKSMINIMUMINSTALLEDVERSION]">DEVFIELDWORKSMINIMUMINSTALLEDVERSION</SetProperty>

	<!--
	"from the list: Don't use Advertise="yes" Advertised shortcuts are designed to allow
users to install just the shortcut for your app, then demand-install the
rest of the app the first time the icon is run.  If this is not behavior you
are trying to support, you're better off using non-advertised shortcuts. "-->
	<Condition Message="Before [ProductName] can install, you need to install SIL's FieldWorks 8.0.3, or higher.">
	  <![CDATA[Installed OR FIELDWORKSMINIMUMINSTALLEDVERSION]]>
	</Condition>

	<PropertyRef Id="NETFRAMEWORK40CLIENT"/>
	<Condition Message="Before [ProductName] can install, you need to install Microsoft's free .NET Framework 4 (Client).">
	  <![CDATA[Installed OR NETFRAMEWORK40CLIENT]]>
	</Condition>

	<!--because of bug, this needs to be 1 -->
	<Property Id="ALLUSERS">1</Property>

	<Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

	<Directory Id="TARGETDIR" Name="SourceDir">

	  <Directory Id="ProgramFilesFolder" Name="PFiles">
		<Directory Id="SILDIR" Name="SIL">
		  <Directory Id="INSTALLDIR" Name="FLEx Bridge">
			<!-- Main bridge assemblies -->
			<Component Id="FLExBridge.exe" Guid="3D9BF2DF-4A25-11DF-9879-0800200C9A66">
			  <File Id="FLExBridge.exe" Name="FLExBridge.exe" Source="..\..\output\Release\FLExBridge.exe"/>
			</Component>
			<Component Id="FLExBridge.pdb" Guid="C1EDBBD2-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExBridge.pdb" Name="FLExBridge.pdb" KeyPath="yes" Source="..\..\output\Release\FLExBridge.pdb"/>
			</Component>
			<Component Id="app.config" Guid="C1EE581C-E382-11DE-8A39-0800200C9A66">
			  <File Id="app.config" Name="app.config" Source="..\..\output\Release\app.config"/>
			</Component>
			<Component Id="FLExChorusPlugin.dll" Guid="C1ED6DB1-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExChorusPlugin.dll" Name="FLEx-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\FLEx-ChorusPlugin.dll"/>
			</Component>
			<Component Id="FLExChorusPlugin.pdb" Guid="C1EDBBD3-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExChorusPlugin.pdb" Name="FLEx-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\FLEx-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="LibFLExBridgeChorusPlugin.dll" Guid="5A362239-BD5F-44A2-9CEC-C18422785D20">
			  <File Id="LibFLExBridgeChorusPlugin.dll" Name="LibFLExBridge-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\LibFLExBridge-ChorusPlugin.dll"/>
			</Component>
			<Component Id="LibFLExBridgeChorusPlugin.pdb" Guid="CE3E02A1-8534-4DB5-BF93-DF484B8EA09F">
			  <File Id="LibFLExBridgeChorusPlugin.pdb" Name="LibFLExBridge-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\LibFLExBridge-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="LiftBridgeChorusPlugin.dll" Guid="C1EDE2FA-E382-11DE-8A39-0800200C9A66">
			  <File Id="LiftBridgeChorusPlugin.dll" Name="LiftBridge-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\LiftBridge-ChorusPlugin.dll"/>
			</Component>
			<Component Id="LiftBridgeChorusPlugin.pdb" Guid="C1EDE2FB-E382-11DE-8A39-0800200C9A66">
			  <File Id="LiftBridgeChorusPlugin.pdb" Name="LiftBridge-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\LiftBridge-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="LibTriboroughBridgeChorusPlugin.dll" Guid="631D0647-1441-4D69-9CC4-5557006BE8C2">
			  <File Id="LibTriboroughBridgeChorusPlugin.dll" Name="LibTriboroughBridge-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\LibTriboroughBridge-ChorusPlugin.dll"/>
			</Component>
			<Component Id="LibTriboroughBridgeChorusPlugin.pdb" Guid="91548EC8-AA95-4E10-8C35-6B02DD638A80">
			  <File Id="LibTriboroughBridgeChorusPlugin.pdb" Name="LibTriboroughBridge-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\LibTriboroughBridge-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="TriboroughBridgeChorusPlugin.dll" Guid="C1EE09F0-E382-11DE-8A39-0800200C9A66">
			  <File Id="TriboroughBridgeChorusPlugin.dll" Name="TriboroughBridge-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\TriboroughBridge-ChorusPlugin.dll"/>
			</Component>
			<Component Id="TriboroughBridgeChorusPlugin.pdb" Guid="C1EE09F1-E382-11DE-8A39-0800200C9A66">
			  <File Id="TriboroughBridgeChorusPlugin.pdb" Name="TriboroughBridge-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\TriboroughBridge-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="RegInstallationDir" Guid="C1EDBBD7-E382-11DE-8A39-0800200C9A66">
			  <RegistryKey Id="keyFLExBridge.exe" Action="createAndRemoveOnUninstall" Root="HKLM" Key="SOFTWARE\[MANUFACTURERREGKEY]\FLEX Bridge\9">
				<RegistryValue Id="FLExBridgeInstallationDir" Type="string" Value="[INSTALLDIR]" Name="InstallationDir"/>
			  </RegistryKey>
			</Component>

			<!-- Desired Chorus pdb files not in the Chorus merge module. -->
			<Component Id="Chorus.pdb" Guid="C1EDBBD4-E382-11DE-8A39-0800200C9A66">
			  <File Id="Chorus.pdb" Name="Chorus.pdb" KeyPath="yes" Source="..\..\output\Release\Chorus.pdb"/>
			</Component>
			<Component Id="ChorusMerge.pdb" Guid="C1EDBBD5-E382-11DE-8A39-0800200C9A66">
			  <File Id="ChorusMerge.pdb" Name="ChorusMerge.pdb" KeyPath="yes" Source="..\..\output\Release\ChorusMerge.pdb"/>
			</Component>
			<Component Id="LibChorus.pdb" Guid="C1EDBBD6-E382-11DE-8A39-0800200C9A66">
			  <File Id="LibChorus.pdb" Name="LibChorus.pdb" KeyPath="yes" Source="..\..\output\Release\LibChorus.pdb"/>
			</Component>

			<!-- Desired SIL pdb files not in the Chorus merge module. -->
			<Component Id="SIL.Windows.Forms.pdb" Guid="0FBA86CD-E104-4117-A3DB-135C1FF22FEC">
			 <File Id="SIL.Windows.Forms.pdb" Name="SIL.Windows.Forms.pdb" KeyPath="yes" Source="..\..\output\Release\SIL.Windows.Forms.pdb"/>
			</Component>
			<Component Id="SIL.Core.pdb" Guid="1C51C23E-DE70-4200-8D45-6795B95A706F">
			 <File Id="SIL.Core.pdb" Name="SIL.Core.pdb" KeyPath="yes" Source="..\..\output\Release\SIL.Core.pdb"/>
			</Component>
			<Component Id="SIL.Lift.pdb" Guid="6850EBC7-50B6-4B09-85D7-5DC7EEC39E76">
			 <File Id="SIL.Lift.pdb" Name="SIL.Lift.pdb" KeyPath="yes" Source="..\..\output\Release\SIL.Lift.pdb"/>
			</Component>


			<Component Id="NetSparkle.Net40.dll" Guid="C1EE311B-E382-11DE-8A39-0800200C9A66">
			  <File Id="NetSparkle.Net40.dll" Name="NetSparkle.Net40.dll" KeyPath="yes" Source="..\..\output\Release\NetSparkle.Net40.dll"/>
			</Component>

			<Component Id="L10NSharp.dll" Guid="C1EE581A-E382-11DE-8A39-0800200C9A66">
			  <File Id="L10NSharp.dll" Name="L10NSharp.dll" KeyPath="yes" Source="..\..\output\Release\L10NSharp.dll"/>
			</Component>

			<Component Id="IPCFramework.dll" Guid="C1EE581D-E382-11DE-8A39-0800200C9A66">
			  <File Id="IPCFramework.dll" Name="IPCFramework.dll" KeyPath="yes" Source="..\..\lib\Release\IPCFramework.dll"/>
			</Component>

			<Component Id="about.htm" Guid="68290B0A-7A61-4486-8E76-DD1C9C3F03BC">
				<File Id="about.htm" Name="about.htm" KeyPath="yes" Source="..\..\output\Installer\about.htm" />
			</Component>

			<Merge Id="ChorusMergeModule" Language="1033" SourceFile="..\..\lib\Release\ChorusMergeModule.msm" DiskId="1"/>
		  </Directory>
		</Directory>
	  </Directory>

	  <!--
	  <Directory Id="ProgramMenuFolder" Name="Programs">
		<Directory Id="DesktopFolder" SourceName="Desktop"/>
		<Directory Id="FLExBridgeShortcutDir" Name="FLEx Bridge">
		  <Component Id="ApplicationShortcut" Guid="3D9BF2DE-4A25-11DF-9879-0800200C9A66">
			<Shortcut Id="startmenuShortcut" Name="FLEx Bridge" Target="[!FLExBridge.exe]" WorkingDirectory="INSTALLDIR" Icon="FLExBridge.ico"/>
			<RemoveFolder Id="FLExBridgeShortcutDir" On="uninstall"/>
			<RegistryValue Root="HKCU" Key="Software\[MANUFACTURERREGKEY]\FLEx Bridge" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
		  </Component>
		</Directory>
	  </Directory>-->
			<Directory Id="SystemFolder" Name="System32">
				<Merge Id="CRT90" Language="1033" SourceFile="..\..\lib\Release\Microsoft_VC90_CRT_x86.msm" DiskId="1"/>
				<Merge Id="CRT90Policy" Language="1033" SourceFile="..\..\lib\Release\policy_9_0_Microsoft_VC90_CRT_x86.msm" DiskId="1"/>
			</Directory>
		</Directory>

	<Feature Id="ProductFeature" Level="1" Title="Basic Stuff">
	  <ComponentRef Id="FLExBridge.exe"/>
	  <ComponentRef Id="FLExBridge.pdb"/>
	  <ComponentRef Id="app.config"/>
	  <ComponentRef Id="FLExChorusPlugin.dll"/>
	  <ComponentRef Id="FLExChorusPlugin.pdb"/>
	  <ComponentRef Id="LibFLExBridgeChorusPlugin.dll"/>
	  <ComponentRef Id="LibFLExBridgeChorusPlugin.pdb"/>

	  <ComponentRef Id="LiftBridgeChorusPlugin.dll"/>
	  <ComponentRef Id="LiftBridgeChorusPlugin.pdb"/>
	  <ComponentRef Id="LibTriboroughBridgeChorusPlugin.dll"/>
	  <ComponentRef Id="LibTriboroughBridgeChorusPlugin.pdb"/>
	  <ComponentRef Id="TriboroughBridgeChorusPlugin.dll"/>
	  <ComponentRef Id="TriboroughBridgeChorusPlugin.pdb"/>

	  <!--<ComponentRef Id="ApplicationShortcut"/>-->
	  <ComponentRef Id="RegInstallationDir"/>
	  <ComponentRef Id="LibChorus.pdb"/>
	  <ComponentRef Id="Chorus.pdb"/>
	  <ComponentRef Id="ChorusMerge.pdb"/>
	  <ComponentRef Id="SIL.Windows.Forms.pdb"/>
	  <ComponentRef Id="SIL.Core.pdb"/>
	  <ComponentRef Id="SIL.Lift.pdb"/>

	  <ComponentRef Id="NetSparkle.Net40.dll"/>
	  <ComponentRef Id="L10NSharp.dll"/>
	  <ComponentRef Id="IPCFramework.dll"/>

	  <ComponentRef Id="about.htm" />

	  <MergeRef Id="ChorusMergeModule"/>
	  <MergeRef Id="CRT90"/>
	  <MergeRef Id="CRT90Policy"/>

			<!-- Generated components (originally, but now stored in Mercurial). Regenerate, if the contents change, or hand-edit, for say DistFiles. -->
	  <ComponentGroupRef Id="DistFiles"/>
	</Feature>

	<Icon Id="FLExBridge.ico" SourceFile="..\..\output\Release\FLExBridge.exe"/>
	<!-- what you see in add/remove programs control panel -->
	<Property Id="ARPPRODUCTICON" Value="FLExBridge.ico"/>
  </Product>
</Wix>
